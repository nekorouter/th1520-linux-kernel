// SPDX-License-Identifier: (GPL-2.0 OR MIT)
/*
 * Copyright (C) 2023 Jisheng Zhang <jszhang@kernel.org>
 * Copyright (C) 2023 Drew Fustini <dfustini@baylibre.com>
 */

/dts-v1/;

#include "th1520.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/leds/common.h>

/ {
	model = "BeagleV Ahead";
	compatible = "beagle,beaglev-ahead", "thead,th1520";


	chosen {
		stdout-path = "serial0:115200n8";
	};

	memory@0 {
		device_type = "memory";
		reg = <0x0 0x200000 0x0 0xffe00000>;
	};

	leds {
		pinctrl-names = "default";
		pinctrl-0 = <&led_pins>;
		compatible = "gpio-leds";

		led-1 {
			gpios = <&gpio4 8 GPIO_ACTIVE_LOW>;
			color = <LED_COLOR_ID_BLUE>;
			label = "led1";
		};

		led-2 {
			gpios = <&gpio4 9 GPIO_ACTIVE_LOW>;
			color = <LED_COLOR_ID_BLUE>;
			label = "led2";
		};

		led-3 {
			gpios = <&gpio4 10 GPIO_ACTIVE_LOW>;
			color = <LED_COLOR_ID_BLUE>;
			label = "led3";
		};

		led-4 {
			gpios = <&gpio4 11 GPIO_ACTIVE_LOW>;
			color = <LED_COLOR_ID_BLUE>;
			label = "led4";
		};

		led-5 {
			gpios = <&gpio4 12 GPIO_ACTIVE_LOW>;
			color = <LED_COLOR_ID_BLUE>;
			label = "led5";
		};
	};

		th1520_iopmp: iopmp {
		compatible = "xuantie,th1520-iopmp";

		/* config#1: multiple valid regions */
		iopmp_emmc: IOPMP_EMMC {
			attr = <0xFFFFFFFF>;
			is_default_region;
		};

		/* config#2: iopmp bypass */
		iopmp_sdio0: IOPMP_SDIO0 {
			bypass_en;
		};

		/* config#3: iopmp default region set */
		iopmp_sdio1: IOPMP_SDIO1 {
			attr = <0xFFFFFFFF>;
			is_default_region;
		};

		iopmp_usb0: IOPMP_USB0 {
			attr = <0xFFFFFFFF>;
			is_default_region;
		};

		iopmp_ao: IOPMP_AO {
			is_default_region;
		};

		iopmp_aud: IOPMP_AUD {
			is_default_region;
		};

		iopmp_chip_dbg: IOPMP_CHIP_DBG {
			is_default_region;
		};

		iopmp_eip120i: IOPMP_EIP120I {
			is_default_region;
		};

		iopmp_eip120ii: IOPMP_EIP120II {
			is_default_region;
		};

		iopmp_eip120iii: IOPMP_EIP120III {
			is_default_region;
		};

		iopmp_isp0: IOPMP_ISP0 {
			is_default_region;
		};

		iopmp_isp1: IOPMP_ISP1 {
			is_default_region;
		};

		iopmp_dw200: IOPMP_DW200 {
			is_default_region;
		};

		iopmp_vipre: IOPMP_VIPRE {
			is_default_region;
		};

		iopmp_venc: IOPMP_VENC {
			is_default_region;
		};

		iopmp_vdec: IOPMP_VDEC {
			is_default_region;
		};

		iopmp_g2d: IOPMP_G2D {
			is_default_region;
		};

		iopmp_fce: IOPMP_FCE {
			is_default_region;
		};

		iopmp_npu: IOPMP_NPU {
			is_default_region;
		};

		iopmp0_dpu: IOPMP0_DPU {
			bypass_en;
		};

		iopmp1_dpu: IOPMP1_DPU {
			bypass_en;
		};

		iopmp_gpu: IOPMP_GPU {
			is_default_region;
		};

		iopmp_gmac1: IOPMP_GMAC1 {
			is_default_region;
		};

		iopmp_gmac2: IOPMP_GMAC2 {
			is_default_region;
		};

		iopmp_dmac: IOPMP_DMAC {
			is_default_region;
		};

		iopmp_tee_dmac: IOPMP_TEE_DMAC {
			is_default_region;
		};

		iopmp_dsp0: IOPMP_DSP0 {
			is_default_region;
		};

		iopmp_dsp1: IOPMP_DSP1 {
			is_default_region;
		};
	};

	mbox_910t_client2: mbox_910t_client2 {
		compatible = "xuantie,th1520-mbox-client";
		mbox-names = "906";
		mboxes = <&mbox_910t 2 0>;
		audio-mbox-regmap = <&audio_mbox>;
		status = "okay";
	};

	th1520_sound: soundcard@1 {
		compatible = "simple-audio-card";
		simple-audio-card,name = "TH1520-Sound-Card";
		#address-cells = <1>;
		#size-cells = <0>;

        simple-audio-card,dai-link@0 {
			reg = <0>;
			format = "i2s";
			cpu {
				sound-dai = <&ap_i2s 1>;
			};
			codec {
				sound-dai = <&hdmi_codec>;
			};
		};
	};

	th1520_rpmsg: th1520_rpmsg {
		compatible = "th1520,rpmsg-bus", "simple-bus";
		memory-region = <&rpmsgmem>;
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;
		rpmsg: rpmsg{
			vdev-nums = <1>;
            reg = <0x0 0x1E000000 0 0x10000>;
			compatible = "th1520,th1520-rpmsg";
			log-memory-region = <&audio_log_mem>;
			audio-text-memory-region = <&audio_text_mem>;
			status = "okay";
		};
	};

	hdmi_codec: hdmi_codec@1 {
		#sound-dai-cells = <0>;
		compatible = "xuantie,th1520-hdmi-pcm";
		status = "okay";
		sound-name-prefix = "DUMMY";
	};

	thermal-zones {
		cpu-thermal {
			sustainable-power = <1600>;

			trips {
				trip_active0: active-0 {
					temperature = <39000>;
					hysteresis = <5000>;
					type = "active";
				};

				trip_active1: active-1 {
					temperature = <50000>;
					hysteresis = <5000>;
					type = "active";
				};

				trip_active2: active-2 {
					temperature = <60000>;
					hysteresis = <5000>;
					type = "active";
				};
			};
		};

		dev-thermal {
			sustainable-power = <3000>;
		};
	};
};

&cpus {
	c910_0: cpu@0 {
		dvdd-supply = <&dvdd_cpu_reg>;
		dvddm-supply = <&dvddm_cpu_reg>;

		operating-points = <
			/* kHz    uV */
			300000  600000
			400000  700000
			500000  700000
			600000  700000
			702000  700000
			800000  700000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
		th1520,dvddm-operating-points = <
			/* kHz   uV */
			300000  800000
			400000  800000
			500000  800000
			600000  800000
			702000  800000
			800000  800000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
	};
	c910_1: cpu@1 {
		dvdd-supply = <&dvdd_cpu_reg>;
		dvddm-supply = <&dvddm_cpu_reg>;

		operating-points = <
			/* kHz    uV */
			300000  600000
			400000  700000
			500000  700000
			600000  700000
			702000  700000
			800000  700000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
		th1520,dvddm-operating-points = <
			/* kHz   uV */
			300000  800000
			400000  800000
			500000  800000
			600000  800000
			702000  800000
			800000  800000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
	};
	c910_2: cpu@2 {
		dvdd-supply = <&dvdd_cpu_reg>;
		dvddm-supply = <&dvddm_cpu_reg>;

		operating-points = <
			/* kHz    uV */
			300000  600000
			400000  700000
			500000  700000
			600000  700000
			702000  700000
			800000  700000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
		th1520,dvddm-operating-points = <
			/* kHz   uV */
			300000  800000
			400000  800000
			500000  800000
			600000  800000
			702000  800000
			800000  800000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
	};
	c910_3: cpu@3 {
		dvdd-supply = <&dvdd_cpu_reg>;
		dvddm-supply = <&dvddm_cpu_reg>;

		operating-points = <
			/* kHz    uV */
			300000  600000
			400000  700000
			500000  700000
			600000  700000
			702000  700000
			800000  700000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
		th1520,dvddm-operating-points = <
			/* kHz   uV */
			300000  800000
			400000  800000
			500000  800000
			600000  800000
			702000  800000
			800000  800000
			900000  800000
			1000000 800000
			1104000 800000
			1200000 800000
			1296000 800000
			1404000 800000
			1500000 800000
			1608000 1000000
			1704000 1000000
			1848000 1000000
		>;
	};
};

&osc {
	clock-frequency = <24000000>;
};

&osc_32k {
	clock-frequency = <32768>;
};

&rc_24m {
	clock-frequency = <24000000>;
};

&aonsys_clk {
	clock-frequency = <73728000>;
};

&audiosys_clk {
	clock-frequency = <294912000>;
};

&apb_clk {
	clock-frequency = <62500000>;
};

&sdhci_clk {
	clock-frequency = <198000000>;
};

&uart_sclk {
	clock-frequency = <100000000>;
};

&aon {
	log-memory-region = <&aon_log_mem>;
	status = "okay";

	dvdd_cpu_reg: appcpu_dvdd {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "appcpu_dvdd";
		regulator-min-microvolt = <300000>;
		regulator-max-microvolt = <1570000>;
		regulator-type = "dvdd";
		regulator-boot-on;
		regulator-always-on;
	};

	dvddm_cpu_reg: appcpu_dvddm {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "appcpu_dvddm";
		regulator-min-microvolt = <300000>;
		regulator-max-microvolt = <1570000>;
		regulator-type = "dvddm";
		regulator-dual-rail;
		regulator-boot-on;
		regulator-always-on;
	};

	soc_dvdd18_aon_reg: soc_dvdd18_aon {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd18_aon";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_avdd33_usb3_reg: soc_avdd33_usb3 {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_avdd33_usb3";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_dvdd08_aon_reg: soc_dvdd08_aon {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd08_aon";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_dvdd08_ddr_reg: soc_dvdd08_ddr {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd08_ddr";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_vdd_ddr_1v8_reg: soc_vdd_ddr_1v8 {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_vdd_ddr_1v8";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_vdd_ddr_1v1_reg: soc_vdd_ddr_1v1 {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_vdd_ddr_1v1";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_vdd_ddr_0v6_reg: soc_vdd_ddr_0v6 {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_vdd_ddr_0v6";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_dvdd18_ap_reg: soc_dvdd18_ap {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd18_ap";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_dvdd08_ap_reg: soc_dvdd08_ap {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd08_ap";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_avdd08_mipi_hdmi_reg: soc_avdd08_mipi_hdmi {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_avdd08_mipi_hdmi";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_avdd18_mipi_hdmi_reg: soc_avdd18_mipi_hdmi {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_avdd18_mipi_hdmi";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_vdd33_emmc_reg: soc_vdd33_emmc {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd33_emmc";
		regulator-type = "common";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_vdd18_emmc_reg: soc_vdd18_emmc {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd18_emmc";
		regulator-type = "gpio";
		regulator-boot-on;
		regulator-always-on;
	};

	soc_dovdd18_scan_reg: soc_dovdd18_scan {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dovdd18_scan";
		regulator-type = "common";
		regulator-min-microvolt = <900000>;
		regulator-max-microvolt = <3600000>;
	};

	soc_dvdd12_scan_reg: soc_dvdd12_scan {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_dvdd12_scan";
		regulator-type = "common";
		regulator-min-microvolt = <900000>;
		regulator-max-microvolt = <3600000>;
	};

	soc_avdd28_scan_en_reg: soc_avdd28_scan_en {
		compatible = "xuantie,th1520-aon-pmic";
		regulator-name = "soc_avdd28_scan_en";
		regulator-type = "common";
		regulator-min-microvolt = <900000>;
		regulator-max-microvolt = <3600000>;
	};
};

&dmac0 {
	status = "okay";
};

&gmac_clk {
        clock-frequency = <500000000>;
};

&gmac_axi_clk {
        clock-frequency = <100000000>;
};

&emmc {
	bus-width = <8>;
	max-frequency = <198000000>;
	mmc-hs400-1_8v;
	non-removable;
	no-sdio;
	no-sd;
	status = "okay";
};

&gmac0 {
	pinctrl-names = "default";
	pinctrl-0 = <&gmac0_pins>;
	phy-mode = "rgmii-id";
	status = "okay";
};

&mdio0 {
        phy0: ethernet-phy@1 {
                reg = <1>;
        };
};

&padctrl_aosys {
	led_pins: led-0 {
		led-pins {
			pins = "AUDIO_PA8",  /* GPIO4_8 */
			       "AUDIO_PA9",  /* GPIO4_9 */
			       "AUDIO_PA10", /* GPIO4_10 */
			       "AUDIO_PA11", /* GPIO4_11 */
			       "AUDIO_PA12"; /* GPIO4_12 */
			function = "gpio";
			bias-disable;
			drive-strength = <3>;
			input-disable;
			input-schmitt-disable;
			slew-rate = <0>;
		};
	};
};

&padctrl0_apsys {
	gmac0_pins: gmac0-0 {
		tx-pins {
			pins = "GMAC0_TX_CLK",
			       "GMAC0_TXEN",
			       "GMAC0_TXD0",
			       "GMAC0_TXD1",
			       "GMAC0_TXD2",
			       "GMAC0_TXD3";
			function = "gmac0";
			bias-disable;
			drive-strength = <25>;
			input-disable;
			input-schmitt-disable;
			slew-rate = <0>;
		};

		rx-pins {
			pins = "GMAC0_RX_CLK",
			       "GMAC0_RXDV",
			       "GMAC0_RXD0",
			       "GMAC0_RXD1",
			       "GMAC0_RXD2",
			       "GMAC0_RXD3";
			function = "gmac0";
			bias-disable;
			drive-strength = <1>;
			input-enable;
			input-schmitt-disable;
			slew-rate = <0>;
		};

		mdc-pins {
			pins = "GMAC0_MDC";
			function = "gmac0";
			bias-disable;
			drive-strength = <13>;
			input-disable;
			input-schmitt-disable;
			slew-rate = <0>;
		};

		mdio-pins {
			pins = "GMAC0_MDIO";
			function = "gmac0";
			bias-disable;
			drive-strength = <13>;
			input-enable;
			input-schmitt-enable;
			slew-rate = <0>;
		};
	};

	sdio0_pins: sdio0-0 {
		detn-pins {
			pins = "SDIO0_DETN";
			function = "sdio";
			bias-disable; /* external pull-up */
			drive-strength = <1>;
			input-enable;
			input-schmitt-enable;
			slew-rate = <0>;
		};
	};

	uart0_pins: uart0-0 {
		tx-pins {
			pins = "UART0_TXD";
			function = "uart";
			bias-disable;
			drive-strength = <3>;
			input-disable;
			input-schmitt-disable;
			slew-rate = <0>;
		};

		rx-pins {
			pins = "UART0_RXD";
			function = "uart";
			bias-disable;
			drive-strength = <1>;
			input-enable;
			input-schmitt-enable;
			slew-rate = <0>;
		};
	};

	hdmi_tx_pins: hdmi-tx-0 {
		hdmi-pins {
			pins = "HDMI_SCL", "HDMI_SDA", "HDMI_CEC";
			function = "hdmi";
			bias-disable;
			drive-strength = <3>;
			input-enable;
			input-schmitt-disable;
			slew-rate = <0>;
		};
	};
};

&emmc {
       bus-width = <8>;
       max-frequency = <198000000>;
       mmc-hs400-1_8v;
       non-removable;
       no-sdio;
       no-sd;
       status = "okay";
};

&sdio0 {
	pinctrl-names = "default";
	pinctrl-0 = <&sdio0_pins>;
	bus-width = <4>;
	max-frequency = <198000000>;
	wprtn_ignore;
	no-sdio;
	status = "okay";
};

&sdio1 {
		max-frequency = <198000000>;
		bus-width = <4>;
		pull_up;
		no-sd;
		no-mmc;
		broken-cd;
		io_fixed_1v8;
		post-power-on-delay-ms = <50>;
		wprtn_ignore;
		cap-sd-highspeed;
		wakeup-source;
		keep-power-in-suspend;
		status = "okay";
};

&uart0 {
	pinctrl-names = "default";
	pinctrl-0 = <&uart0_pins>;
	status = "okay";
};

&resmem {
	#address-cells = <2>;
	#size-cells = <2>;
	ranges;

	/* global autoconfigured region for contiguous allocations */
	cmamem: linux,cma {
		compatible = "shared-dma-pool";
		reusable;
		size = <0 0x14000000>; // 512MB on lpi4a (SOM)
		alloc-ranges = <00 0xe4000000 0 0x14000000>;
		linux,cma-default;
	};
	dsp0_mem: memory@20000000 {             /**0x2000_0000~0x2040_0000 4M**/
		reg = <0x0 0x20000000 0x0 0x00280000   /* DSP FW code&data section 2.5M*/
			0x0 0x20280000 0x0 0x00001000   /* DSP communication area 4K*/
			0x0 0x20281000 0x0 0x00007000  /* Panic/log page 28K */
			0x0 0x20288000 0x0 0x00178000>;  /* DSP shared memory 1.5M-32K*/
		};
	dsp1_mem: memory@20400000 {             /**0x2040_0000~0x2080_0000 4M**/
		reg = <0x0 0x20400000 0x0 0x00280000  /* DSP FW code&data section */
			0x0 0x20680000 0x0 0x00001000 /* DSP communication area */
			0x0 0x20681000 0x0 0x00007000    /* Panic/log page*/
			0x0 0x20688000 0x0 0x00178000>;  /* DSP shared memory */
		};
    vi_mem: framebuffer@0f800000 {
		reg = <0x0 0x0F800000 0x0 0x05400000	/* vi_mem_pool_region[0]  84 MB (default) */
		       0x0 0x14C00000 0x0 0x01D00000	/* vi_mem_pool_region[1]  29 MB */
		       0x0 0x16900000 0x0 0x03200000>;	/* vi_mem_pool_region[2]  50 MB */
	};

    audio_text_mem: memory@32000000 {
		reg = <0x0 0x32000000 0x0 0xE00000>;
		//no-map;
    };
    audio_data_mem: memory@32E00000 {
		reg = <0x0 0x32E00000 0x0 0x600000>;
		//no-map;
    };
	audio_log_mem: memory@33400000 {
        reg = <0x0 0x33400000 0x0 0x200000>;
	};
	//Note: with "no-map" reserv mem not saved in hibernation
	rpmsgmem: memory@1E000000 {
		reg = <0x0 0x1E000000 0x0 0x10000>;
	};
	aon_log_mem: memory@33600000 {
        reg = <0x0 0x33600000 0x0 0x200000>;
	};
	regdump_mem: memory@38400000 {
		reg = <0x0 0x38400000 0x0 0x1400000>;
		no-map;
	};
};

&regdump {
	memory-region = <&regdump_mem>;
	status = "okay";
};

&ap_i2s {
	status = "okay";
};

&dpu_enc1 {
	ports {
		/delete-node/ port@0;
	};
};

&disp1_out {
	remote-endpoint = <&hdmi_tx_in>;
};

&hdmi_tx {
	status = "okay";

	port@0 {
		/* input */
		hdmi_tx_in: endpoint {
			remote-endpoint = <&disp1_out>;
		};
	};
};

&isp0 {
	status = "okay";
};

&isp1 {
	status = "okay";
};

&isp_ry0 {
	status = "okay";
};

&dewarp {
	status = "okay";
};

&dec400_isp0 {
	status = "okay";
};

&dec400_isp1 {
	status = "okay";
};

&dec400_isp2 {
	status = "okay";
};

&bm_visys {
	status = "okay";
};

&bm_csi0 {
	status = "okay";
};

&bm_csi1 {
	status = "okay";
};

&bm_csi2 {
	status = "okay";
};

&vidmem {
	status = "okay";
	memory-region = <&vi_mem>;
};

&vi_pre {
	status = "okay";
};

&xtensa_dsp {
	status = "okay";
};

&xtensa_dsp0 {
	status = "okay";
	memory-region = <&dsp0_mem>;
};

&xtensa_dsp1 {
	status = "okay";
	memory-region = <&dsp1_mem>;
};

&gpu {
	status = "okay";
};

&npu {
	vha_clk_rate = <1000000000>;
	status = "okay";
};

&npu_opp_table {
	opp-1000000000 {
		opp-suspend;
	};
};

&dpu_enc1 {
	ports {
		/delete-node/ port@0;
	};
};

&disp1_out {
	remote-endpoint = <&hdmi_tx_in>;
};

&hdmi_tx {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&hdmi_tx_pins>;

	port@0 {
		/* input */
		hdmi_tx_in: endpoint {
			remote-endpoint = <&disp1_out>;
		};
	};
};

&eip_28 {
	status = "okay";
};